# -------------------------------
# Upload Panel
# -------------------------------
class UploadPanel(tk.Frame):
    def __init__(self, master, on_file_selected, **kwargs):
        super().__init__(master, **kwargs)
        self.on_file_selected = on_file_selected
        self.create_widgets()

    def create_widgets(self):
        upload_frame = ttk.Frame(self)
        upload_frame.pack(fill=tk.BOTH, expand=True, pady=20)
        file_frame = ttk.Frame(upload_frame)
        file_frame.pack(fill=tk.X, pady=20)
        ttk.Label(file_frame, text="Selected File:").pack(side=tk.LEFT, padx=(0, 10))
        self.file_path = tk.StringVar()
        self.file_entry = ttk.Entry(file_frame, textvariable=self.file_path, width=60)
        self.file_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 10))
        browse_button = ttk.Button(file_frame, text="Browse", command=self.browse_file)
        browse_button.pack(side=tk.LEFT)
        self.file_path.trace('w', self.on_file_path_change)

    def browse_file(self):
        filename = filedialog.askopenfilename(
            title="Select a ZIP file", filetypes=[("ZIP files", "*.zip")])
        if filename:
            self.file_path.set(filename)
            self.on_file_selected(filename)  # Call callback immediately when file is selected

    def on_file_path_change(self, *args):
        if self.file_path.get():
            self.on_file_selected(self.file_path.get())  # Call callback when path changes

class ActionPanel(tk.Frame):
    def __init__(self, master, controller, username, password, saved_configs, servers, **kwargs):
        super().__init__(master, **kwargs)
        self.controller = controller
        self.username = username
        self.password = password
        self.saved_configs = saved_configs
        self.servers = servers  # List of tuples: (Environment, Hostname)
        self.selected_config_name = None
        self.selected_file = None
        self.create_data = None
        self.source_hostname = None
        self.target_hostname = None
        self.current_action = None
        self.action_buttons = {}  # To store references to action buttons
        self.side_panel_buttons = {}  # To store references to side panel buttons
        # Set default selected server to the first one
        self.selected_server = self.servers[0]
        self.current_panel_mode = "saved_configurations"  # Default panel mode
        self.is_panel_expanded = True  # Track if side panel is expanded
        self.side_panel_width = 200  # Default width of side panel when expanded
        self.create_widgets()

    def create_widgets(self):
        # ---------------------------
        # Banner: Program name and new action buttons
        # ---------------------------
        banner_frame = ttk.Frame(self)
        banner_frame.pack(fill=tk.X, padx=5, pady=10)  # Increased padding makes banner bigger
        
        # Program name on the far left (with a slightly larger font)
        program_label = tk.Label(banner_frame, text="bmc api", font=('TkDefaultFont', 14, 'bold'))
        program_label.pack(side=tk.LEFT, padx=(5, 10))

        # Vertical Separator
        separator = ttk.Separator(banner_frame, orient=tk.VERTICAL)
        separator.pack(side=tk.LEFT, fill=tk.Y, padx=(0, 10))
        
        # New action buttons in the banner
        options = ["Saved Configurations", "CCS Server"]
        for option in options:
            btn = tk.Button(banner_frame,
                            text=option,
                            command=lambda opt=option: self.switch_panel_mode(opt),
                            relief="flat", bd=0, padx=10, pady=5)
            btn.pack(side=tk.LEFT, padx=5)
            self.action_buttons[option] = btn

        # ---------------------------
        # Orange line underneath the banner
        # ---------------------------
        orange_line = tk.Frame(self, bg="orange", height=2)
        orange_line.pack(fill=tk.X, padx=0, pady=(0, 0))
        
        # ---------------------------
        # Main content container to hold side panel and content area
        # ---------------------------
        main_container = ttk.Frame(self)
        main_container.pack(fill=tk.BOTH, expand=True)
        
        # ---------------------------
        # Side panel (runs the entire length below the banner)
        # ---------------------------
        self.side_panel_container = ttk.Frame(main_container)
        self.side_panel_container.pack(side=tk.LEFT, fill=tk.Y, padx=0, pady=0)
        
        self.side_panel = ttk.Frame(self.side_panel_container, width=self.side_panel_width)
        self.side_panel.pack(side=tk.LEFT, fill=tk.Y, padx=0, pady=0)
        self.side_panel.pack_propagate(False)  # Don't shrink to fit content
        
        # Toggle button for collapsing/expanding side panel
        self.toggle_frame = ttk.Frame(self.side_panel_container, width=20)
        self.toggle_frame.pack(side=tk.LEFT, fill=tk.Y)
        
        # Configure toggle frame with dark grey background
        toggle_style = ttk.Style()
        toggle_style.configure("Toggle.TFrame", background="#444444")
        self.toggle_frame.configure(style="Toggle.TFrame")
        
        # Add toggle button with arrow icon
        self.toggle_button = tk.Button(
            self.toggle_frame, 
            text="â—€", 
            command=self.toggle_side_panel,
            relief="flat", 
            bd=0, 
            bg="#444444", 
            fg="white", 
            activebackground="#555555", 
            activeforeground="white"
        )
        self.toggle_button.pack(side=tk.TOP, pady=10)
        
        # Side panel style - dark grey background
        side_panel_style = ttk.Style()
        side_panel_style.configure("SidePanel.TFrame", background="#444444")
        self.side_panel.configure(style="SidePanel.TFrame")
        
        # ---------------------------
        # Content area (right of side panel)
        # ---------------------------
        self.content_area = ttk.Frame(main_container)
        self.content_area.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # ---------------------------
        # Initialize both panel modes but only show the default one
        # ---------------------------
        self.create_saved_configs_panel()
        self.create_ccs_server_panel()
        self.switch_panel_mode("Saved Configurations")  # Start with saved configurations
        
    def create_saved_configs_panel(self):
        # Clear any existing content in the side panel
        for widget in self.side_panel.winfo_children():
            widget.destroy()
        
        # Create buttons for saved configurations in the side panel
        options = ["Download", "Upload", "Restore", "Create", "Update"]
        for option in options:
            btn = tk.Button(self.side_panel,
                           text=option,
                           command=lambda opt=option: self.show_panel(opt),
                           relief="flat", bd=0, padx=10, pady=10,
                           bg="#444444", fg="white", activebackground="#555555", activeforeground="white",
                           width=20, anchor="w")
            btn.pack(fill=tk.X, pady=1)
            self.side_panel_buttons[option] = btn
            
    def create_ccs_server_panel(self):
        # Clear any existing content in the side panel
        for widget in self.side_panel.winfo_children():
            widget.destroy()
        
        # Create buttons for saved configurations in the side panel
        options = ["Create from Excel"]
        for option in options:
            btn = tk.Button(self.side_panel,
                           text=option,
                           command=lambda opt=option: self.show_panel(opt),
                           relief="flat", bd=0, padx=10, pady=10,
                           bg="#444444", fg="white", activebackground="#555555", activeforeground="white",
                           width=20, anchor="w")
            btn.pack(fill=tk.X, pady=1)
            self.side_panel_buttons[option] = btn
            
    def switch_panel_mode(self, mode):
        # Update button colors in banner
        for act, button in self.action_buttons.items():
            if act == mode:
                button.config(bg="orange", activebackground="orange", fg="white")
            else:
                button.config(bg="SystemButtonFace", activebackground="SystemButtonFace", fg="black")
        
        # Clear any existing content in the content area
        for widget in self.content_area.winfo_children():
            widget.destroy()
            
        # Update the side panel and content area based on the selected mode
        if mode == "Saved Configurations":
            self.current_panel_mode = "saved_configurations"
            self.create_saved_configs_panel()
            self.setup_saved_configs_content()
        elif mode == "CCS Server":
            self.current_panel_mode = "ccs_server"
            self.create_ccs_server_panel()
            self.setup_ccs_server_content()
            
    def setup_saved_configs_content(self):
        # ---------------------------
        # Title and Current Server Label (centered)
        # ---------------------------
        title_label = ttk.Label(self.content_area, text="Manage Saved Configurations", font=('TkDefaultFont', 12, 'bold'))
        title_label.pack(pady=(10, 5))
        self.current_server_label = ttk.Label(
            self.content_area,
            text=f"Current Server: {self.selected_server[0]} ({self.selected_server[1]})",
            font=('TkDefaultFont', 10)
        )
        self.current_server_label.pack(pady=(0, 10))

        # ---------------------------
        # Server Drop-Down Button (aligned to the left)
        # ---------------------------
        server_dropdown_frame = ttk.Frame(self.content_area)
        server_dropdown_frame.pack(fill=tk.X, padx=5, pady=(0, 10), anchor="w")
        self.servers_mb = tk.Menubutton(server_dropdown_frame, text="Change Server â–¼", relief="flat", bd=0)
        self.servers_mb.menu = tk.Menu(self.servers_mb, tearoff=0)
        self.servers_mb["menu"] = self.servers_mb.menu
        for server in self.servers:
            env, hostname = server
            label = f"{env} ({hostname})"
            self.servers_mb.menu.add_command(label=label, command=lambda s=server: self.set_server(s))
        self.servers_mb.pack(side=None)
        
        # ---------------------------
        # Container for dynamic panels and action button
        # ---------------------------
        self.panel_container = ttk.Frame(self.content_area)
        self.panel_container.pack(fill=tk.BOTH, expand=True, pady=10)
        self.button_frame = ttk.Frame(self.content_area)
        self.button_frame.pack(pady=10)
        
    def setup_ccs_server_content(self):
        # ---------------------------
        # Title for CCS Server management
        # ---------------------------
        title_label = ttk.Label(self.content_area, text="Manage CCS Servers", font=('TkDefaultFont', 12, 'bold'))
        title_label.pack(pady=(10, 5))
        self.current_server_label = ttk.Label(
            self.content_area,
            text=f"Current Server: {self.selected_server[0]} ({self.selected_server[1]})",
            font=('TkDefaultFont', 10)
        )
        self.current_server_label.pack(pady=(0, 10))

        # ---------------------------
        # Server Drop-Down Button (aligned to the left)
        # ---------------------------
        server_dropdown_frame = ttk.Frame(self.content_area)
        server_dropdown_frame.pack(fill=tk.X, padx=5, pady=(0, 10), anchor="w")
        self.servers_mb = tk.Menubutton(server_dropdown_frame, text="Change Server â–¼", relief="flat", bd=0)
        self.servers_mb.menu = tk.Menu(self.servers_mb, tearoff=0)
        self.servers_mb["menu"] = self.servers_mb.menu
        for server in self.servers:
            env, hostname = server
            label = f"{env} ({hostname})"
            self.servers_mb.menu.add_command(label=label, command=lambda s=server: self.set_server(s))
        self.servers_mb.pack(side=None)
        
        # ---------------------------
        # Container for dynamic panels and action button
        # ---------------------------
        self.panel_container = ttk.Frame(self.content_area)
        self.panel_container.pack(fill=tk.BOTH, expand=True, pady=10)
        self.button_frame = ttk.Frame(self.content_area)
        self.button_frame.pack(pady=10)
        
        # Note: The CCS server content area is similar to saved configurations
        # but with a different title. You can add more specific content as needed.

    def set_server(self, server):
        self.selected_server = server
        # Update the server label in the current content area
        for widget in self.content_area.winfo_children():
            if isinstance(widget, ttk.Label) and hasattr(widget, 'cget') and widget.cget('text').startswith("Current Server:"):
                widget.config(text=f"Current Server: {server[0]} ({server[1]})")
                break
        
        self.controller.connect(server[1], self.username, self.password)
        new_configs = self.controller.get_saved_configurations()
        self.saved_configs = new_configs
        print(f"Connected to new server: {server[0]} ({server[1]})")
        for widget in self.panel_container.winfo_children():
            if hasattr(widget, 'refresh_configs'):
                widget.saved_configs = new_configs
                widget.refresh_configs()

    def show_panel(self, action):
        self.current_action = action
        # Update button colors in side panel: set the active button to orange, others to default
        for act, button in self.side_panel_buttons.items():
            if act == action:
                button.config(bg="#FF8C00", activebackground="#FF8C00", fg="white")
            else:
                button.config(bg="#444444", activebackground="#555555", fg="white")

        # Clear any existing panel from the panel container and button frame
        for widget in self.panel_container.winfo_children():
            widget.destroy()
        for widget in self.button_frame.winfo_children():
            widget.destroy()

        if action in ['Download', 'Restore']:
            panel = DownloadRestorePanel(self.panel_container, action, self.saved_configs,
                                        self.username, self.controller.mvcm, self.on_config_select)
            panel.pack(fill=tk.BOTH, expand=True)
            panel.refresh_configs()
        elif action == 'Upload':
            panel = UploadPanel(self.panel_container, self.on_file_select)
            panel.pack(fill=tk.BOTH, expand=True)
        elif action == 'Create':
            panel = CreatePanel(self.panel_container, self.on_create)
            panel.pack(fill=tk.BOTH, expand=True)
        elif action == 'Update':
            panel = UpdatePanel(self.panel_container, self.servers, self.on_update_select)
            panel.pack(fill=tk.BOTH, expand=True)

        # Add the process button
        process_button = tk.Button(self.button_frame, text=action, command=self.process_action)
        process_button.pack(pady=10)
        
        self.master.bind('<Return>', lambda e: self.process_action())

    def on_config_select(self, config_name):
        self.selected_config_name = config_name

    def on_file_select(self, file_path):
        if file_path and os.path.exists(file_path):
            self.selected_file = file_path

    def on_create(self, name, description):
        if name:
            self.create_data = (name, description)

    def on_update_select(self, source_hostname, target_hostname):
        self.source_hostname = source_hostname
        self.target_hostname = target_hostname

    def process_action(self):
        action = self.current_action
        if action == 'Download' and self.selected_config_name:
            dl_location = None
            for widget in self.panel_container.winfo_children():
                if hasattr(widget, 'download_location'):
                    dl_location = widget.download_location.get()
                    break
            if not dl_location:
                dl_location = fr"C:\Users\{self.username}\OneDrive - Fiserv Corp\Documents\saved_configuration.zip"
            success = self.controller.download_configuration(self.selected_config_name, dl_location)
            if success:
                print(f"Successfully downloaded the ZIP file to {dl_location}")
            else:
                print("Download failed.")
        elif action == 'Restore' and self.selected_config_name:
            success = self.controller.restore_configuration(self.selected_config_name)
            print("Restore successful!" if success else "Restore failed.")
        elif action == 'Upload' and self.selected_file:
            success = self.controller.upload_configuration(self.selected_file)
            print("Upload successful!" if success else "Upload failed.")
        elif action == 'Create' and self.create_data:
            name, description = self.create_data
            if name:
                success = self.controller.create_configuration(name, description)
                print("Configuration created successfully!" if success else "Creation failed.")
            else:
                print("Name is required for creation.")
        elif action == 'Update' and self.source_hostname and self.target_hostname:
            self.process_update()
        else:
            print("Required selections are missing for the chosen action.")

    def process_update(self):
        # Disable all buttons during update
        for button in self.side_panel_buttons.values():
            button.config(state=tk.DISABLED)
        
        # Create and show loading dialog
        loading_dialog = LoadingDialog(self, "Updating configuration, please wait...")
        loading_dialog.start()  # Start the progress bar animation
        
        def update_thread():
            success = False
            error_message = None
            try:
                success = self.controller.update_configuration(
                    self.source_hostname,
                    self.target_hostname,
                    self.username,
                    self.password
                )
            except Exception as e:
                error_message = str(e)
            finally:
                # Schedule UI updates in the main thread
                if loading_dialog.winfo_exists():  # Check if dialog still exists
                    self.after(0, lambda: self.update_complete(loading_dialog, success, error_message))
        
        # Start the update process in a separate thread
        thread = threading.Thread(target=update_thread, daemon=True)
        thread.start()

    def update_complete(self, loading_dialog, success, error_message=None):
        try:
            # Re-enable all buttons
            for button in self.side_panel_buttons.values():
                button.config(state=tk.NORMAL)
            
            # Destroy the loading dialog
            if loading_dialog.winfo_exists():
                loading_dialog.destroy()
            
            # Show appropriate message
            if success:
                messagebox.showinfo("Success", "Update process completed successfully!")
            else:
                error_msg = "Update failed." if not error_message else f"Update failed: {error_message}"
                messagebox.showerror("Error", error_msg)
        except Exception as e:
            print(f"Error in update_complete: {str(e)}")
    
    def toggle_side_panel(self):
        """Toggle the side panel between collapsed and expanded states"""
        if self.is_panel_expanded:
            # Collapse the panel
            self.side_panel.pack_forget()
            self.toggle_button.config(text="â–¶")  # Change arrow direction
            self.is_panel_expanded = False
        else:
            # Expand the panel
            self.side_panel.pack(side=tk.LEFT, fill=tk.Y, padx=0, pady=0)
            self.toggle_button.config(text="â—€")  # Change arrow direction
            self.is_panel_expanded = True
